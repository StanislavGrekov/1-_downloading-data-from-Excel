
&НаКлиенте
Процедура Загрузить(Команда)
	
	ЗагрузкаФайлаКлиент();

КонецПроцедуры

&НаКлиенте
Асинх Процедура ЗагрузкаФайлаКлиент()
	
	Если Не РеквизитыЗаполнены() Тогда
		Сообщить("Не все реквизиты заполнены!");
		Возврат;
	КонецЕсли;

	ОписаниеПомещенногоФайла = Ждать ПоместитьФайлНаСерверАсинх(,,,ПутьКФайлу, УникальныйИдентификатор);

	Если ОписаниеПомещенногоФайла = Неопределено Или ОписаниеПомещенногоФайла.ПомещениеФайлаОтменено Тогда
		Сообщить("Загрузка файла на сервер не состоялась");
		Возврат;
	КонецЕсли;
	
	ДанныеЗаписаны = ОбработатьФайлНаСервере(ОписаниеПомещенногоФайла.Адрес, ОписаниеПомещенногоФайла.СсылкаНаФайл.Расширение,Договор,Контрагент,Организация);
	
	Если ДанныеЗаписаны Тогда
		Сообщить("Данные добавлены успешно");
	КонецЕсли;
	
КонецПроцедуры


&НаСервере
Функция ОбработатьФайлНаСервере(АдресВХранилище,Расширение,Договор,Контрагент,Организация);
	
	ИмяВременногоФайла =ПолучитьИмяВременногоФайла(Расширение);
	
	ДанныеФайла = ПолучитьИзВременногоХранилища(АдресВХранилище);
	
	ДанныеФайла.Записать(ИмяВременногоФайла);
	
	ТабДок = Новый ТабличныйДокумент;
	ТабДок.Прочитать(ИмяВременногоФайла);

	КоличествоСтрок = ТабДок.ВысотаТаблицы;
	
	//Формируем Массив для проверки номенклутуры
	
	МассивКодовНоменклатуры = Новый Массив;
	
	Для Сч = 2 ПО КоличествоСтрок-1 Цикл
		
		Код = СокрЛП(ТабДок.Область(Сч,1).Текст);
		МассивКодовНоменклатуры.Добавить(Код); 
		
	КонецЦикла;
	
	КодЗаведеннойНоменклатуры = ПоискНоменклатурыВСправочнике(МассивКодовНоменклатуры);
	
	//Формируем документ
	
	НовыйДокумент = Документы.ПоступлениеТоваровИУслуг.СоздатьДокумент();
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Договор = Договор;
	НовыйДокумент.Контрагент = Контрагент;
	НовыйДокумент.Организация = Организация;
	
	Для Сч = 2 ПО КоличествоСтрок-1 Цикл
		
		Код = СокрЛП(ТабДок.Область(Сч,1).Текст); 
		Номенклатура = СокрЛП(ТабДок.Область(Сч,2).Текст);
		ЕдиницаИзмерения = СокрЛП(ТабДок.Область(Сч,3).Текст); 
		Количество = СокрЛП(ТабДок.Область(Сч,4).Текст);
		Цена = СокрЛП(ТабДок.Область(Сч,5).Текст);
		Сумма = СокрЛП(ТабДок.Область(Сч,6).Текст);
		СтавкаНДС = СокрЛП(ТабДок.Область(Сч,7).Текст);
		
		ИндексЗаведеннойНоменклатуры = КодЗаведеннойНоменклатуры.Найти(Код);
		
		Если ИндексЗаведеннойНоменклатуры <> Неопределено Тогда
			
			НоваяНоменклатура = Справочники.Номенклатура.НайтиПоКоду(Код);
			
		Иначе 
			
			НоваяНоменклатура = Справочники.Номенклатура.СоздатьЭлемент();	
			НоваяНоменклатура.Код = Код;
			НоваяНоменклатура.Наименование = Номенклатура;
			НоваяНоменклатура.Записать();
		КонецЕсли;
		
		СтрокаТабличнойЧасти = НовыйДокумент.ТабличнаяЧасть.Добавить();
		
		СтрокаТабличнойЧасти.Код = НоваяНоменклатура.Код;
		СтрокаТабличнойЧасти.Номенклатура = НоваяНоменклатура;
		
		Если ЕдиницаИзмерения = "шт" Тогда 
			СтрокаТабличнойЧасти.ЕдиницаИзмерения = Перечисления.ЕдиницаИзмерения.шт;
		КонецЕсли;
		
		СтрокаТабличнойЧасти.Количество = Число(Количество);	
		СтрокаТабличнойЧасти.Сумма = Число(Сумма);
		СтрокаТабличнойЧасти.Цена = Число(Цена);
		
		Если СтавкаНДС = "20%" Тогда
			СтрокаТабличнойЧасти.СтавкаНДС = Перечисления.СтавкаНДС.НДС20;
		ИначеЕсли СтавкаНДС = "10%" Тогда
			СтрокаТабличнойЧасти.СтавкаНДС = Перечисления.СтавкаНДС.НДС10;
		КонецЕсли;

	КонецЦикла;
	
	НовыйДокумент.Проведен = Истина;
	НовыйДокумент.Записать();
	
	Возврат Истина;
	
КонецФункции


&НаКлиенте
Асинх Процедура ПутьКФайлуНачалоВыбораНаКлиенте()

	Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
	Диалог.Фильтр = "Таблицы|*.xlsx;*.xls;*.ods;*.mxl"; 
	Диалог.МножественныйВыбор = Ложь;
	Диалог.Заголовок = "Выберите файл:";
	
	Обещание = Диалог.ВыбратьАсинх();
	ВыбранныеФайлы = Ждать Обещание;
	
	Если ВыбранныеФайлы = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ПутьКФайлу = ВыбранныеФайлы[0]; 

КонецПроцедуры


&НаКлиенте
Процедура ПутьКФайлуНачалоВыбора(Элемент, ДанныеВыбора, ВыборДобавлением, СтандартнаяОбработка) 
	
	ПутьКФайлуНачалоВыбораНаКлиенте();  
	
КонецПроцедуры

&НаКлиенте
Функция РеквизитыЗаполнены()
	
	Если ЗначениеЗаполнено(Контрагент) ИЛИ 
			ЗначениеЗаполнено(ПутьКФайлу) ИЛИ
			ЗначениеЗаполнено(Организация) ИЛИ 
			ЗначениеЗаполнено(Договор)Тогда
		Возврат Истина;
	Иначе
		Возврат Ложь;
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ПоискНоменклатурыВСправочнике(МассивКодовНоменклатуры)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	Номенклатура.Код КАК Код
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.Код В(&МассивКодов)";
	
	Запрос.УстановитьПараметр("МассивКодов", МассивКодовНоменклатуры);
	
	Выборка = Запрос.Выполнить().Выбрать(); 
	
	
	КодЗаведеннойНоменклатуры = Новый Массив;
	
	Пока Выборка.Следующий() Цикл
		
		КодЗаведеннойНоменклатуры.Добавить(Выборка.Код);
		
	КонецЦикла;
	
	Возврат КодЗаведеннойНоменклатуры;
	
	
КонецФункции
